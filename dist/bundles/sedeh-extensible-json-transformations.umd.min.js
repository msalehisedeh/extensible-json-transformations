!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("@sedeh/extensible-json-transformations",["exports","@angular/core","@angular/common"],e):e((t.sedeh=t.sedeh||{},t.sedeh["extensible-json-transformations"]={}),t.ng.core,t.ng.common)}(this,function(t,e,o){"use strict";var r=function(){function t(t){this.path=t.split(".")}return t.prototype.fromLast=function(){return new t(this.path[this.path.length-1])},t.prototype.nodeOf=function(t){return this._nodeOf(t,this.path)},t.prototype._nodeOf=function(t,e){for(var o=t,r=0;r<this.path.length;r++){if(o instanceof Array){for(var n=[],s=0;s<this.path.length;s++){var i=o[s],a=this._nodeOf(i[e[r]],e.slice(r+1,e.length));a&&null!==a&&n.push(a)}n.length&&(o=n);break}o=o?o[e[r]]:o}return o},t.prototype.valueOf=function(t){return this._valueOf(t,this.path)},t.prototype._valueOf=function(t,e){for(var o=t,r=0;r<this.path.length;r++){if(o instanceof Array){for(var n=[],s=0;s<this.path.length;s++){var i=o[s];n.push(this._valueOf(i[e[r]],e.slice(r+1,e.length)))}o=n;break}o=e.length&&o?o[e[r]]:o}return o},t}(),n=function(){function t(){this.supportedMethods={},this.templates={},this.globalPool={},this.pathPool={},this.addSupportingMethod("valueOf",this.valueOf),this.addSupportingMethod("each",this.each),this.addSupportingMethod("split",this.split),this.addSupportingMethod("concat",this.concatenate),this.addSupportingMethod("enlist",this.enlist),this.addSupportingMethod("join",this.join),this.addSupportingMethod("filter",this.filter),this.addSupportingMethod("select",this.select),this.addSupportingMethod("style",this.style),this.addSupportingMethod("match",this.match),this.addSupportingMethod("apply",this.apply),this.addSupportingMethod("filter",this.filter),this.addSupportingMethod("select",this.select),this.addSupportingMethod("offPool",this.offPool)}return t.prototype.jXPathFor=function(t){var e=this.pathPool[t];return e||(e=new r(t),this.pathPool[t]=e),e},t.prototype.setRootNode=function(t){this.rootNode=this.nodeList(t),this.initPools(this.templates)},t.prototype.setContextNode=function(t){this.contextNode=t},t.prototype.templateForName=function(t){return this.templates[t]},t.prototype.nodeList=function(t){var e,o=null===t?this.rootNode:t;if(o instanceof Array)e=o;else{var r=Object.keys(o);e=[];for(var n=0;n<r.length;n++){var s=r[n];o[s]instanceof Array?e=e.concat(o[s]):e.push(o[s])}}return e},t.prototype.query=function(t,e){var o=this.toQueryOperation(t);if(e instanceof Array){for(var r=[],n=0;n<e.length;n++){var s=e[n];r=r.concat(this.invoke(o,s))}return r}return this.invoke(o,e)},t.prototype.invoke=function(t,e){var o=[];if("object"==typeof e&&e instanceof Array&&0===e.length)o=[];else if("object"==typeof t){var r=this.supportedMethods[t.name];if(r){if(t.args instanceof Array)for(var n=0;n<t.args.length;n++){var s=t.args[n];s.name?o.push(this.invoke(s,e)):o.push(s)}else o.push(t.args);var i=this.contextNode;this.contextNode=e,o=r.apply(this,o),this.contextNode=i}else o=t.name}else o=t;return o},t.prototype.concatenate=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=t[0],r=t[1],n=t[2],s=[];if(o instanceof Array)if(n instanceof Array)if(o.length>n.length)for(var i=0;i<o.length;i++)s.push(o[i]+r+(n.length>i?n[i]:""));else for(i=0;i<n.length;i++)s.push((o.length>i?o[i]:"")+r+n[i]);else for(i=0;i<o.length;i++)s.push(o[i]+r+n);else if(n instanceof Array)for(i=0;i<n.length;i++)s.push(o+r+n[i]);else s.push(o+r+n);return 1<s.length?s:s[0]},t.prototype.split=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t[0]?t[0].split(t[1]):[]},t.prototype.valueOf=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.jXPathFor(t[0]).valueOf(this.contextNode)},t.prototype.each=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=[],r={name:"valueOf",args:t[1]},n=0;n<t[0].length;n++){var s=t[0][n];o.push(this.invoke(r,s))}return o},t.prototype.enlist=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=[];return t.map(function(t){o.push(t)}),o},t.prototype.join=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return 1<t[0].length?t[0].join(t[1]):t[0]},t.prototype.apply=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=this.jXPathFor(t[1]),r=o.fromLast(),n=t[2],s=[],i=0;i<this.rootNode.length;i++){var a=this.rootNode[i],h=o.nodeOf(a);if(h instanceof Array)for(var l=0;l<h.length;l++){var f=h[l],p=r.valueOf(f);this.evaluateOperation(p,"=",n)&&s.push(f)}else{p=r.valueOf(a);this.evaluateOperation(p,"=",n)&&s.push(a)}}return s.length&&(s=this.style(t[0],s)),s},t.prototype.match=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=this.templateForName(t[0]);if(!o)throw{message:"Missing Template definition for '"+t[0]+"'.",stack:(new Error).stack};var r=this.jXPathFor(t[1]),n=r.fromLast(),s=t[2],i=t[3],a=this.templateNodes(o,this.contextNode),h=[];if(a instanceof Array)for(var l=0;l<a.length;l++){var f,p=a[l];if((f=r.nodeOf(p))instanceof Array)for(var u=0;u<f.length;u++){var c=f[u],g=n.valueOf(c);this.evaluateOperation(g,s,i)&&h.push(c)}else{g=n.valueOf(p);this.evaluateOperation(g,s,i)&&h.push(p)}}else if((f=r.nodeOf(a))instanceof Array)for(u=0;u<f.length;u++){c=f[u],g=n.valueOf(c);this.evaluateOperation(g,s,i)&&h.push(c)}else{g=n.valueOf(a);this.evaluateOperation(g,s,i)&&h.push(a)}return h},t.prototype.filter=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=this.jXPathFor(t[0]),r=t[1],n=t[2],s=[],i=0;i<this.contextNode.length;i++){var a=this.contextNode[i],h=o.valueOf(a);if(h instanceof Array)for(var l=0;l<h.length;l++){var f=h[l];this.evaluateOperation(f,r,n)&&s.push(a)}else this.evaluateOperation(h,r,n)&&s.push(a)}return s},t.prototype.select=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=this.jXPathFor(t[0]),r=[];if(this.contextNode instanceof Array)for(var n=0;n<this.contextNode.length;n++){var s,i=this.contextNode[n];(s=o.nodeOf(i))&&s.length&&r.push(i)}else(s=o.nodeOf(this.contextNode))&&s.length&&(s instanceof Array?r=s:r.push(s));return r},t.prototype.style=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=this.templateForName(t[0]);if(!o)throw{message:"Missing Template definition for '"+t[0]+"'.",stack:(new Error).stack};var r=[],n=Object.keys(o.style);if(t[1]instanceof Array)for(var s=0;s<t[1].length;s++){for(var i=t[1][s],a={},h=0;h<n.length;h++){a[l=n[h]]=this.invoke(o.style[l],i)}r.push(a)}else{for(a={},h=0;h<n.length;h++){var l;a[l=n[h]]=this.invoke(o.style[l],t[1])}r.push(a)}return r},t.prototype.addSupportingMethod=function(t,e){this.supportedMethods[t]=e},t.prototype.removeQuotes=function(t){return t.length&&"'"===t[0]&&"'"===t[t.length-1]?t.substring(1,t.length-1):t},t.prototype.toQueryOperation=function(t){var e=t.replace(/([^']+)|('[^']+')/g,function(t,e,o){return e?e.replace(/\s/g,""):o}).replace(/'[^']+'/g,function(t){return t.replace(/,/g,"~")});return this.toFunctions(e)},t.prototype.toFunctions=function(t){for(var e=-1,o=-1,r=-1,n=0,s={},i=0;i<t.length;i++)if("("===t[i])0===n&&(e=i),n++;else if(")"===t[i]){if(0===--n)o=i,(a=s instanceof Array)||o!==t.length-1?(a||(s=[]),s.push({name:t.substring(r+1,e),args:this.toFunctions(t.substring(e+1,o))})):(s.name=t.substring(0,e),s.args=this.toFunctions(t.substring(e+1,o)))}else if(","===t[i])if(0===n&&i-1!==r){var a=s instanceof Array;if(r<0)e<0&&(a||(s=[]),s.push({name:this.removeQuotes(t.substring(r+1,i).replace(/~/g,",")),args:[]})),r=i;else{var h=this.removeQuotes(t.substring(r+1,i).replace(/~/g,","));h.indexOf("(")<0&&(s instanceof Array?s.push(h):s.args.push(h)),r=i}}else 0===n&&i-1===r&&(r=i);if(0<=e&&o<0)throw{message:"incorrect method call declaration. Missing ')'",stack:(new Error).stack};if(e<0&&0<o)throw{message:"incorrect method call declaration. Missing '('",stack:(new Error).stack};return e<0&&o<0&&r<0?t:(0===n&&o<r&&(s instanceof Array?s.push(this.removeQuotes(t.substring(r+1,t.length).replace(/~/g,","))):s.args.push(this.removeQuotes(t.substring(r+1,t.length).replace(/~/g,",")))),s)},t.prototype.templateNodes=function(t,e){var o=[],r=e;if("root"===t.context){if(!this.rootNode)throw{message:"Unable to find root node to perform operation.",stack:(new Error).stack};r=this.nodeList(this.rootNode)}if(t.match&&t.match.length)for(var n=this.jXPathFor(t.match),s=0;s<r.length;s++){var i=r[s];n.valueOf(i)===t.value&&o.push(i)}else e&&(o=r);return o},t.prototype.evaluateOperation=function(t,e,o){var r=!1;if(o instanceof Array){if("="===e){for(var n=0;n<o.length;n++)if(t==o[n]){r=!0;break}}else if("in"===e){for(n=0;n<o.length;n++)if(0<=o[n].indexOf(t)){r=!0;break}}else if("!"===e){var s=!1;for(n=0;n<o.length;n++)if(t==o[n]){s=!0;break}r=!s}}else"="===e?r=t==o:"in"===e?r=0<=o.indexOf(t):"!"===e?r=t!==o:">"===e?r=parseFloat(t)>parseFloat(o):"<"===e&&(r=parseFloat(t)<parseFloat(o));return r},t.prototype.offPool=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=[],r=this.globalPool[t[0]],n=t[1];if(!r)throw{message:"Attempting to access pool '"+t[0]+"' that is not created.",stack:(new Error).stack};if(n instanceof Array)for(var s=0;s<n.length;s++){var i;(i=r[n[s]])&&o.push(i)}else(i=r[n])&&o.push(i);return o},t.prototype.initTemplates=function(t){this.templates={};for(var e=0;e<t.length;e++){for(var o=t[e],r=Object.keys(o.style),n=0;n<r.length;n++){var s=r[n],i=o.style[s];"string"==typeof i&&(o.style[s]=this.toQueryOperation(i))}this.templates[o.name]=o}},t.prototype.initPools=function(t){var e=Object.keys(t);if(0===e.length)throw{message:"Missing Template definitions.",stack:(new Error).stack};if(!this.rootNode)throw{message:"Unable to find root node to perform operation.",stack:(new Error).stack};this.globalPool={};for(var o=0;o<e.length;o++){var r=e[o],n=this.templateForName(r);if(n.inPool){var s={},i=this.jXPathFor(n.inPool),a=n.match,h=this.rootNode;if(a&&n.value)for(var l=this.jXPathFor(a),f=0;f<h.length;f++){l.valueOf(h[f])===n.value&&(s[i.valueOf(h[f])]=h[f])}else for(f=0;f<h.length;f++)s[i.valueOf(h[f])]=h[f];this.globalPool[n.name]=s}}},t}(),s=function(){function t(t){this.inquirer=new n,this.transformations=t,this.inquirer.initTemplates(this.transformations.templates)}return t.prototype.changeRootNode=function(t){this.inquirer.setRootNode(t)},t.prototype.transform=function(){var t=[],e=this.inquirer.templateForName(this.transformations.rootTemplate);if(e)for(var o=Object.keys(e.style),r=this.inquirer.templateNodes(e,this.inquirer.nodeList(null)),n=0;n<r.length;n++){for(var s=r[n],i={},a=0;a<o.length;a++){var h=o[a];i[h]=this.inquirer.invoke(e.style[h],s)}t.push(i)}if(this.transformations.onResult&&this.transformations.onResult.length){var l=this.inquirer.toQueryOperation(this.transformations.onResult);t=this.inquirer.invoke(l,t)}return t},t}(),i=function(){function t(){this.node={},this.ontransformation=new e.EventEmitter,this.onerror=new e.EventEmitter}return t.prototype.ngOnInit=function(){if(this.node&&this.transformations){this.styler||(this.styler=new s(this.transformations)),this.styler.changeRootNode(this.node);try{this.ontransformation.emit(this.styler.transform())}catch(t){console.log(t),this.onerror.emit(t)}}},t.prototype.ngOnChanges=function(t){t.transformations?(this.styler=undefined,setTimeout(this.ngOnInit.bind(this),333)):t.node&&setTimeout(this.ngOnInit.bind(this),333)},t.decorators=[{type:e.Component,args:[{selector:"xjslt",template:""}]}],t.propDecorators={node:[{type:e.Input,args:["node"]}],transformations:[{type:e.Input,args:["transformations"]}],ontransformation:[{type:e.Output,args:["ontransformation"]}],onerror:[{type:e.Output,args:["onerror"]}]},t}(),a=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{imports:[o.CommonModule],declarations:[i],exports:[i],entryComponents:[i],providers:[],schemas:[e.CUSTOM_ELEMENTS_SCHEMA]}]}],t}();t.XjsltComponent=i,t.Styler=s,t.JXPath=r,t.Inquirer=n,t.XjsltModule=a,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=sedeh-extensible-json-transformations.umd.min.js.map